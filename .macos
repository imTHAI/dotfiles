#!/usr/bin/env zsh

# Fermer les Pr√©f√©rences Syst√®me pour √©viter les conflits
osascript -e 'tell application "System Preferences" to quit'

# Demander le mot de passe admin
sudo -v

# Garder sudo actif pendant l'ex√©cution
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

###############################################################################
# üñ•Ô∏è Nom d‚Äôh√¥te et configuration syst√®me
###############################################################################

echo -n "Entrez le nom d'h√¥te souhait√© : "
read hostn

if [[ -z "$hostn" ]]; then
  echo "‚ùå Erreur : aucun nom d'h√¥te fourni."
  exit 1
fi

echo "üîß D√©finition du nom d'h√¥te sur : $hostn"

sudo scutil --set ComputerName "$hostn"
sudo scutil --set HostName "$hostn"
sudo scutil --set LocalHostName "$hostn"
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName "$hostn"

# Afficher les infos syst√®me dans l‚Äô√©cran de login
sudo defaults write /Library/Preferences/com.apple.loginwindow AdminHostInfo HostName

# D√©sactiver le son de d√©marrage
sudo nvram SystemAudioVolume=" "

echo "‚úÖ Nom d'h√¥te et configuration syst√®me appliqu√©s."

###############################################################################
# üß© UI/UX g√©n√©ral
###############################################################################

echo "üîß Configuration de l‚Äôinterface utilisateur..."

# R√©duire le d√©lai de redimensionnement des fen√™tres
defaults write NSGlobalDomain NSWindowResizeTime -float 0.001

# Agrandir les panneaux de sauvegarde et d‚Äôimpression par d√©faut
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# Quitter l‚Äôapp d‚Äôimpression une fois les t√¢ches termin√©es
defaults write com.apple.print.PrintingPrefs "Quit When Finished" -bool true

# D√©sactiver le dialogue ‚ÄúVoulez-vous vraiment ouvrir cette app ?‚Äù
defaults write com.apple.LaunchServices LSQuarantine -bool false

# Afficher les caract√®res ASCII de contr√¥le dans les vues texte
defaults write NSGlobalDomain NSTextShowsControlCharacters -bool true

# D√©sactiver les suggestions d‚Äôemoji (macOS Sonoma et Sequoia)
sudo defaults write /Library/Preferences/FeatureFlags/Domain/UIKit.plist emoji_enhancements -dict-add Enabled -bool NO

# D√©sactiver la terminaison automatique des apps inactives
defaults write NSGlobalDomain NSDisableAutomaticTermination -bool true

# D√©sactiver le mode flottant des fen√™tres d‚Äôaide
defaults write com.apple.helpviewer DevMode -bool true

# Afficher les infos syst√®me dans l‚Äô√©cran de login
sudo defaults write /Library/Preferences/com.apple.loginwindow AdminHostInfo HostName

echo "‚úÖ UI/UX configur√©e avec succ√®s."

###############################################################################
# üñ±Ô∏è Trackpad, clavier, souris, Bluetooth
###############################################################################

echo "üîß Configuration du trackpad, clavier et accessoires..."

# Activer le tap-to-click pour l‚Äôutilisateur actuel et l‚Äô√©cran de login
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Clic droit en bas √† droite du trackpad
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true
defaults -currentHost write NSGlobalDomain com.apple.trackpad.trackpadCornerClickBehavior -int 1
defaults -currentHost write NSGlobalDomain com.apple.trackpad.enableSecondaryClick -bool true

# D√©sactiver le d√©filement "naturel" (style Lion)
defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false

# Am√©liorer la qualit√© audio Bluetooth
defaults write com.apple.BluetoothAudioAgent "Apple Bitpool Min (editable)" -int 40

# Activer l‚Äôacc√®s complet au clavier (tabulation dans les bo√Ætes de dialogue)
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

# D√©sactiver le press-and-hold pour les touches (pr√©f√©rer la r√©p√©tition)
# defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# R√©glage de la vitesse de r√©p√©tition du clavier
defaults write NSGlobalDomain KeyRepeat -int 1
defaults write NSGlobalDomain InitialKeyRepeat -int 10

echo "‚úÖ Trackpad, clavier et Bluetooth configur√©s."

###############################################################################
# üåç Langue, formats et fuseau horaire
###############################################################################

echo "üîß Configuration des pr√©f√©rences linguistiques et r√©gionales..."

# D√©finir les langues principales (fran√ßais + kirundi en exemple)
defaults write NSGlobalDomain AppleLanguages -array "fr" "rn"

# D√©finir la locale (France, euro)
defaults write NSGlobalDomain AppleLocale -string "fr_FR@currency=EUR"

# Unit√©s m√©triques et centim√®tres
defaults write NSGlobalDomain AppleMeasurementUnits -string "Centimeters"
defaults write NSGlobalDomain AppleMetricUnits -bool true

# Afficher le menu de langue √† l‚Äô√©cran de d√©marrage
sudo defaults write /Library/Preferences/com.apple.loginwindow showInputMenu -bool true

# sudo systemsetup -settimezone "Europe/Paris" > /dev/null

echo "‚úÖ Langue, formats et fuseau horaire configur√©s."

###############################################################################
# üîã √ânergie et veille (version corrig√©e)
###############################################################################

echo "üîß Configuration des param√®tres d‚Äô√©nergie..."

# V√©rifier si la commande systemsetup est disponible
if command -v systemsetup >/dev/null; then
  sudo systemsetup -setrestartfreeze on 2>/dev/null || echo "‚ö†Ô∏è Red√©marrage en cas de gel non autoris√© (SIP ?)"
  sudo systemsetup -setcomputersleep Off 2>/dev/null || echo "‚ö†Ô∏è Mise en veille d√©sactiv√©e refus√©e (SIP ?)"
else
  echo "‚ö†Ô∏è Commande systemsetup non disponible."
fi

# Param√®tres pmset (fonctionnent m√™me avec SIP actif)
sudo pmset -a lidwake 1
sudo pmset -a autorestart 1
sudo pmset -a displaysleep 15
sudo pmset -b sleep 5
sudo pmset -a hibernatemode 0
sudo pmset -a standbydelay 86400

echo "‚úÖ Param√®tres d‚Äô√©nergie appliqu√©s (avec v√©rification SIP)."

###############################################################################
# üñºÔ∏è √âcran et captures d‚Äô√©cran
###############################################################################

echo "üîß Configuration de l‚Äô√©cran et des captures..."

# R√©activer l‚Äôanticr√©nelage des polices (utile sur certains √©crans non Apple)
defaults write -g CGFontRenderingFontSmoothingDisabled -bool FALSE
defaults write NSGlobalDomain AppleFontSmoothing -int 1

# Enregistrer les captures d‚Äô√©cran au format PNG
defaults write com.apple.screencapture type -string "png"

# (Optionnel) D√©sactiver l‚Äôombre port√©e dans les captures
# defaults write com.apple.screencapture disable-shadow -bool true

# (Optionnel) D√©finir l‚Äôemplacement des captures sur le bureau
# defaults write com.apple.screencapture location -string "${HOME}/Desktop"

# Activer les modes HiDPI (n√©cessite red√©marrage)
# sudo defaults write /Library/Preferences/com.apple.windowserver DisplayResolutionEnabled -bool true

echo "‚úÖ Param√®tres d‚Äô√©cran et de capture appliqu√©s."

###############################################################################
# üóÇÔ∏è Finder
###############################################################################

echo "üîß Configuration du Finder..."

# Permettre de quitter Finder avec ‚åò + Q
defaults write com.apple.finder QuitMenuItem -bool true

# D√©sactiver les animations de fen√™tres et de "Lire les infos"
defaults write com.apple.finder DisableAllAnimations -bool true

# D√©finir le dossier par d√©faut √† l‚Äôouverture de Finder
defaults write com.apple.finder NewWindowTarget -string "PfLo"
defaults write com.apple.finder NewWindowTargetPath -string "file://${HOME}/"

# Afficher les p√©riph√©riques amovibles sur le bureau
defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool true

# Afficher la barre de statut et la barre de chemin
defaults write com.apple.finder ShowStatusBar -bool true
defaults write com.apple.finder ShowPathbar -bool true

# Afficher le chemin POSIX complet dans le titre des fen√™tres
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true

# Garder les dossiers en haut lors du tri par nom
defaults write com.apple.finder _FXSortFoldersFirst -bool true

# Rechercher dans le dossier courant par d√©faut
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

# D√©sactiver l‚Äôavertissement lors du changement d‚Äôextension
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

# √âviter la cr√©ation de .DS_Store sur les volumes r√©seau et USB
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# Utiliser la vue en liste par d√©faut
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

# D√©sactiver l‚Äôavertissement avant de vider la corbeille
defaults write com.apple.finder WarnOnEmptyTrash -bool false

# Activer AirDrop sur Ethernet et sur les Macs non support√©s
defaults write com.apple.NetworkBrowser BrowseAllInterfaces -bool true

# Afficher ~/Library
chflags nohidden ~/Library && xattr -d com.apple.FinderInfo ~/Library 2>/dev/null

# Afficher /Volumes
sudo chflags nohidden /Volumes

# √âtendre les panneaux "Lire les infos" par d√©faut
defaults write com.apple.finder FXInfoPanesExpanded -dict \
  General -bool true \
  OpenWith -bool true \
  Privileges -bool true

echo "‚úÖ Finder configur√© avec succ√®s."

###############################################################################
# üöÄ Dock et Launchpad
###############################################################################

echo "üîß Configuration du Dock et du Launchpad..."

# Effet de survol dans les piles du Dock
defaults write com.apple.dock mouse-over-hilite-stack -bool true

# Effet de r√©duction : "scale" au lieu de "genie"
defaults write com.apple.dock mineffect -string "scale"

# R√©duction dans l‚Äôic√¥ne de l‚Äôapp
defaults write com.apple.dock minimize-to-application -bool true

# D√©sactiver l‚Äôanimation d‚Äôouverture des apps
defaults write com.apple.dock launchanim -bool false

# D√©sactiver Dashboard
defaults write com.apple.dashboard mcx-disabled -bool true
defaults write com.apple.dock dashboard-in-overlay -bool true

# Ne pas r√©organiser les Spaces automatiquement
defaults write com.apple.dock mru-spaces -bool false

# Supprimer le d√©lai d‚Äôaffichage du Dock
defaults write com.apple.dock autohide-delay -float 0

# Supprimer l‚Äôanimation d‚Äôaffichage/masquage du Dock
defaults write com.apple.dock autohide-time-modifier -float 0

# Rendre les ic√¥nes des apps masqu√©es translucides
defaults write com.apple.dock showhidden -bool true

# Ne pas afficher les apps r√©centes dans le Dock
defaults write com.apple.dock show-recents -bool false

# R√©initialiser le Launchpad (supprime les bases de donn√©es)
dock_db="$HOME/Library/Application Support/Dock"
if [[ -d "$dock_db" ]]; then
  find "$dock_db" -name "*-*.db" -maxdepth 1 -delete
  echo "üßº Launchpad r√©initialis√©."
else
  echo "‚ö†Ô∏è Dossier Launchpad introuvable, r√©initialisation ignor√©e."
fi

echo "‚úÖ Dock et Launchpad configur√©s."

###############################################################################
# üßº Nettoyage et red√©marrage
###############################################################################

echo "üîß Nettoyage final..."

# Red√©marrer le Finder pour appliquer les changements
killall Finder &>/dev/null && echo "üîÑ Finder relanc√©."

# Red√©marrer le Dock pour appliquer les changements
killall Dock &>/dev/null && echo "üîÑ Dock relanc√©."

# Red√©marrer Safari si modifi√©
killall Safari &>/dev/null && echo "üîÑ Safari relanc√©."

# Optionnel : red√©marrer le syst√®me
echo ""
echo "üéâ Configuration termin√©e !"
echo "üîÅ Certaines modifications n√©cessitent un red√©marrage complet pour √™tre appliqu√©es."
echo "üëâ Tu peux red√©marrer maintenant ou plus tard."

# Demander √† l'utilisateur s‚Äôil souhaite red√©marrer
echo -n "Souhaites-tu red√©marrer maintenant ? (o/n) : "
read reponse

if [[ "$reponse" == "o" || "$reponse" == "O" ]]; then
  echo "üñ•Ô∏è Red√©marrage en cours..."
  sudo shutdown -r now
else
  echo "üëç Tr√®s bien, tu peux red√©marrer plus tard manuellement."
fi
