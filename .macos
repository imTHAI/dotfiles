#!/usr/bin/env zsh

# Fermer les PrÃ©fÃ©rences SystÃ¨me pour Ã©viter les conflits
osascript -e 'tell application "System Preferences" to quit'

# Demander le mot de passe admin
sudo -v

# Garder sudo actif pendant l'exÃ©cution
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

###############################################################################
# ğŸ–¥ï¸ Nom dâ€™hÃ´te et configuration systÃ¨me
###############################################################################

echo -n "Entrez le nom d'hÃ´te souhaitÃ© : "
read hostn

if [[ -z "$hostn" ]]; then
  echo "âŒ Erreur : aucun nom d'hÃ´te fourni."
  exit 1
fi

echo "ğŸ”§ DÃ©finition du nom d'hÃ´te sur : $hostn"

sudo scutil --set ComputerName "$hostn"
sudo scutil --set HostName "$hostn"
sudo scutil --set LocalHostName "$hostn"
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName "$hostn"

# Afficher les infos systÃ¨me dans lâ€™Ã©cran de login
sudo defaults write /Library/Preferences/com.apple.loginwindow AdminHostInfo HostName

# DÃ©sactiver le son de dÃ©marrage
sudo nvram SystemAudioVolume=" "

echo "âœ… Nom d'hÃ´te et configuration systÃ¨me appliquÃ©s."

###############################################################################
# ğŸ§© UI/UX gÃ©nÃ©ral
###############################################################################

echo "ğŸ”§ Configuration de lâ€™interface utilisateur..."

# RÃ©duire le dÃ©lai de redimensionnement des fenÃªtres
defaults write NSGlobalDomain NSWindowResizeTime -float 0.001

# Agrandir les panneaux de sauvegarde et dâ€™impression par dÃ©faut
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# Quitter lâ€™app dâ€™impression une fois les tÃ¢ches terminÃ©es
defaults write com.apple.print.PrintingPrefs "Quit When Finished" -bool true

# DÃ©sactiver le dialogue â€œVoulez-vous vraiment ouvrir cette app ?â€
defaults write com.apple.LaunchServices LSQuarantine -bool false

# Afficher les caractÃ¨res ASCII de contrÃ´le dans les vues texte
defaults write NSGlobalDomain NSTextShowsControlCharacters -bool true

# DÃ©sactiver les suggestions dâ€™emoji (macOS Sonoma et Sequoia)
sudo defaults write /Library/Preferences/FeatureFlags/Domain/UIKit.plist emoji_enhancements -dict-add Enabled -bool NO

# DÃ©sactiver la terminaison automatique des apps inactives
defaults write NSGlobalDomain NSDisableAutomaticTermination -bool true

# DÃ©sactiver le mode flottant des fenÃªtres dâ€™aide
defaults write com.apple.helpviewer DevMode -bool true

# Afficher les infos systÃ¨me dans lâ€™Ã©cran de login
sudo defaults write /Library/Preferences/com.apple.loginwindow AdminHostInfo HostName

echo "âœ… UI/UX configurÃ©e avec succÃ¨s."

###############################################################################
# ğŸ–±ï¸ Trackpad, clavier, souris, Bluetooth
###############################################################################

echo "ğŸ”§ Configuration du trackpad, clavier et accessoires..."

# Activer le tap-to-click pour lâ€™utilisateur actuel et lâ€™Ã©cran de login
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Clic droit en bas Ã  droite du trackpad
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true
defaults -currentHost write NSGlobalDomain com.apple.trackpad.trackpadCornerClickBehavior -int 1
defaults -currentHost write NSGlobalDomain com.apple.trackpad.enableSecondaryClick -bool true

# DÃ©sactiver le dÃ©filement "naturel" (style Lion)
defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false

# AmÃ©liorer la qualitÃ© audio Bluetooth
defaults write com.apple.BluetoothAudioAgent "Apple Bitpool Min (editable)" -int 40

# Activer lâ€™accÃ¨s complet au clavier (tabulation dans les boÃ®tes de dialogue)
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

# DÃ©sactiver le press-and-hold pour les touches (prÃ©fÃ©rer la rÃ©pÃ©tition)
# defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# RÃ©glage de la vitesse de rÃ©pÃ©tition du clavier
defaults write NSGlobalDomain KeyRepeat -int 1
defaults write NSGlobalDomain InitialKeyRepeat -int 10

echo "âœ… Trackpad, clavier et Bluetooth configurÃ©s."

###############################################################################
# ğŸŒ Langue, formats et fuseau horaire
###############################################################################

echo "ğŸ”§ Configuration des prÃ©fÃ©rences linguistiques et rÃ©gionales..."

# DÃ©finir les langues principales (franÃ§ais + kirundi en exemple)
defaults write NSGlobalDomain AppleLanguages -array "fr" "rn"

# DÃ©finir la locale (France, euro)
defaults write NSGlobalDomain AppleLocale -string "fr_FR@currency=EUR"

# UnitÃ©s mÃ©triques et centimÃ¨tres
defaults write NSGlobalDomain AppleMeasurementUnits -string "Centimeters"
defaults write NSGlobalDomain AppleMetricUnits -bool true

# Afficher le menu de langue Ã  lâ€™Ã©cran de dÃ©marrage
sudo defaults write /Library/Preferences/com.apple.loginwindow showInputMenu -bool true

# sudo systemsetup -settimezone "Europe/Paris" > /dev/null

echo "âœ… Langue, formats et fuseau horaire configurÃ©s."

###############################################################################
# ğŸ”‹ Ã‰nergie et veille (version corrigÃ©e)
###############################################################################

echo "ğŸ”§ Configuration des paramÃ¨tres dâ€™Ã©nergie..."

# VÃ©rifier si la commande systemsetup est disponible
if command -v systemsetup >/dev/null; then
  sudo systemsetup -setrestartfreeze on 2>/dev/null || echo "âš ï¸ RedÃ©marrage en cas de gel non autorisÃ© (SIP ?)"
  sudo systemsetup -setcomputersleep Off 2>/dev/null || echo "âš ï¸ Mise en veille dÃ©sactivÃ©e refusÃ©e (SIP ?)"
else
  echo "âš ï¸ Commande systemsetup non disponible."
fi

# ParamÃ¨tres pmset (fonctionnent mÃªme avec SIP actif)
sudo pmset -a lidwake 1
sudo pmset -a autorestart 1
sudo pmset -a displaysleep 15
sudo pmset -b sleep 5
sudo pmset -a hibernatemode 0
sudo pmset -a standbydelay 86400

echo "âœ… ParamÃ¨tres dâ€™Ã©nergie appliquÃ©s (avec vÃ©rification SIP)."

###############################################################################
# ğŸ–¼ï¸ Ã‰cran et captures dâ€™Ã©cran
###############################################################################

echo "ğŸ”§ Configuration de lâ€™Ã©cran et des captures..."

# RÃ©activer lâ€™anticrÃ©nelage des polices (utile sur certains Ã©crans non Apple)
defaults write -g CGFontRenderingFontSmoothingDisabled -bool FALSE
defaults write NSGlobalDomain AppleFontSmoothing -int 1

# Enregistrer les captures dâ€™Ã©cran au format PNG
defaults write com.apple.screencapture type -string "png"

# (Optionnel) DÃ©sactiver lâ€™ombre portÃ©e dans les captures
# defaults write com.apple.screencapture disable-shadow -bool true

# (Optionnel) DÃ©finir lâ€™emplacement des captures sur le bureau
# defaults write com.apple.screencapture location -string "${HOME}/Desktop"

# Activer les modes HiDPI (nÃ©cessite redÃ©marrage)
# sudo defaults write /Library/Preferences/com.apple.windowserver DisplayResolutionEnabled -bool true

echo "âœ… ParamÃ¨tres dâ€™Ã©cran et de capture appliquÃ©s."

###############################################################################
# ğŸ—‚ï¸ Finder
###############################################################################

echo "ğŸ”§ Configuration du Finder..."

# Permettre de quitter Finder avec âŒ˜ + Q
defaults write com.apple.finder QuitMenuItem -bool true

# DÃ©sactiver les animations de fenÃªtres et de "Lire les infos"
defaults write com.apple.finder DisableAllAnimations -bool true

# DÃ©finir le dossier par dÃ©faut Ã  lâ€™ouverture de Finder
defaults write com.apple.finder NewWindowTarget -string "PfLo"
defaults write com.apple.finder NewWindowTargetPath -string "file://${HOME}/"

# Afficher les pÃ©riphÃ©riques amovibles sur le bureau
defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool true

# Afficher la barre de statut et la barre de chemin
defaults write com.apple.finder ShowStatusBar -bool true
defaults write com.apple.finder ShowPathbar -bool true

# Afficher le chemin POSIX complet dans le titre des fenÃªtres
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true

# Garder les dossiers en haut lors du tri par nom
defaults write com.apple.finder _FXSortFoldersFirst -bool true

# Rechercher dans le dossier courant par dÃ©faut
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

# DÃ©sactiver lâ€™avertissement lors du changement dâ€™extension
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

# Ã‰viter la crÃ©ation de .DS_Store sur les volumes rÃ©seau et USB
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# Utiliser la vue en liste par dÃ©faut
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

# DÃ©sactiver lâ€™avertissement avant de vider la corbeille
defaults write com.apple.finder WarnOnEmptyTrash -bool false

# Activer AirDrop sur Ethernet et sur les Macs non supportÃ©s
defaults write com.apple.NetworkBrowser BrowseAllInterfaces -bool true

# Afficher ~/Library
chflags nohidden ~/Library && xattr -d com.apple.FinderInfo ~/Library 2>/dev/null

# Afficher /Volumes
sudo chflags nohidden /Volumes

# Ã‰tendre les panneaux "Lire les infos" par dÃ©faut
defaults write com.apple.finder FXInfoPanesExpanded -dict \
  General -bool true \
  OpenWith -bool true \
  Privileges -bool true

echo "âœ… Finder configurÃ© avec succÃ¨s."

###############################################################################
# ğŸš€ Dock et Launchpad
###############################################################################

echo "ğŸ”§ Configuration du Dock et du Launchpad..."

# Effet de survol dans les piles du Dock
defaults write com.apple.dock mouse-over-hilite-stack -bool true

# Effet de rÃ©duction : "scale" au lieu de "genie"
defaults write com.apple.dock mineffect -string "scale"

# RÃ©duction dans lâ€™icÃ´ne de lâ€™app
defaults write com.apple.dock minimize-to-application -bool true

# DÃ©sactiver lâ€™animation dâ€™ouverture des apps
defaults write com.apple.dock launchanim -bool false

# DÃ©sactiver Dashboard
defaults write com.apple.dashboard mcx-disabled -bool true
defaults write com.apple.dock dashboard-in-overlay -bool true

# Ne pas rÃ©organiser les Spaces automatiquement
defaults write com.apple.dock mru-spaces -bool false

# Supprimer le dÃ©lai dâ€™affichage du Dock
defaults write com.apple.dock autohide-delay -float 0

# Supprimer lâ€™animation dâ€™affichage/masquage du Dock
defaults write com.apple.dock autohide-time-modifier -float 0

# Rendre les icÃ´nes des apps masquÃ©es translucides
defaults write com.apple.dock showhidden -bool true

# Ne pas afficher les apps rÃ©centes dans le Dock
defaults write com.apple.dock show-recents -bool false

# RÃ©initialiser le Launchpad (supprime les bases de donnÃ©es)
dock_db="$HOME/Library/Application Support/Dock"
if [[ -d "$dock_db" ]]; then
  find "$dock_db" -name "*-*.db" -maxdepth 1 -delete
  echo "ğŸ§¼ Launchpad rÃ©initialisÃ©."
else
  echo "âš ï¸ Dossier Launchpad introuvable, rÃ©initialisation ignorÃ©e."
fi

echo "âœ… Dock et Launchpad configurÃ©s."

###############################################################################
# ğŸ§¼ Nettoyage et redÃ©marrage
###############################################################################

echo "ğŸ”§ Nettoyage final..."

# RedÃ©marrer le Finder pour appliquer les changements
killall Finder &>/dev/null && echo "ğŸ”„ Finder relancÃ©."

# RedÃ©marrer le Dock pour appliquer les changements
killall Dock &>/dev/null && echo "ğŸ”„ Dock relancÃ©."

# RedÃ©marrer Safari si modifiÃ©
killall Safari &>/dev/null && echo "ğŸ”„ Safari relancÃ©."

# Optionnel : redÃ©marrer le systÃ¨me
echo ""
echo "ğŸ‰ Configuration terminÃ©e !"
echo "ğŸ” Certaines modifications nÃ©cessitent un redÃ©marrage complet pour Ãªtre appliquÃ©es."
echo "ğŸ‘‰ Tu peux redÃ©marrer maintenant ou plus tard."

# Demander Ã  l'utilisateur sâ€™il souhaite redÃ©marrer
echo -n "Souhaites-tu redÃ©marrer maintenant ? (o/n) : "
read reponse

if [[ "$reponse" == "o" || "$reponse" == "O" ]]; then
  echo "ğŸ–¥ï¸ RedÃ©marrage en cours..."
  sudo shutdown -r now
else
  echo "ğŸ‘ TrÃ¨s bien, tu peux redÃ©marrer plus tard manuellement."
fi
